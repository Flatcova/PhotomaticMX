<%- layout('admin') -%>

<div class="jumbotron">
  <h4 class="text-center">Categorias Disponibles</h4>
  <table class="table">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Informacion</th>
        <th>Foto de portada</th>
        <th>Funcion</th>
      </tr>
    </thead>
    <tbody>
      <%for (var i = 0; i < categorias.length; i++) {%>
        <tr>
          <td><%= categorias[i].nombre %></td>
          <td><%= categorias[i].informacion %></td>
          <td><%= categorias[i].nombreFoto %></td>
          <td><a href="/admin/servicios/categorias/delete?id=<%= categorias[i].id %>" class="btn btn-primary">Eliminar</a></td>
        </tr>
      <% } %>
      </tbody>
    </table>
  </div>

  <div class="jumbotron">
      <h4 class="text-center">Agregar nueva categoria</h4>

      <% if (avisos.length > 0) { %>
        <div class="alert alert-success">
          <h3><%= avisos %></h3>
        </div>
      <% } %>
      <div id="form">
      <div class="form-group">
        <label>Nombre de la categoria</label>
        <input required type="text" class="form-control" id="nombre" placeholder="Ej. Bodas, XV's, Infantil "name="nombre">
      </div>
      <div class="form-group">
        <label>Descripción de la categoria</label>
        <input required type="text" name="informacion" class="form-control" id="informacion" placeholder="Descripción breve de la categoria">
      </div>
      <div class="form-group">
        <label>Seleccionar imagen</label>
        <input class="form-control" type="file" id="foto" single name="nombreFoto">
      </div>
      <div class="text-center" id="form-end">
        <button type="submit" onclick="upload()" class="btn btn-primary"><i class="fa fa-plus"></i> Agregar Categoria </button>
      </div>
    </div>
  </div>
  <script type="text/javascript">

  function upload() {
    [$('#foto')[0].files].forEach(fileObj => {
      var file = fileObj[0]
      // console.log(file);
      // Retrieve a URL from our server.
      retrieveNewURL(file, url => {
        // Upload the file to the server.
        uploadFile(file, url)
      })
    })
  }

  // Request to our Node.js server for an upload URL.
  function retrieveNewURL(file, cb) {
    $.get(`/admin/servicios/fotoUpload?name=${file.name}`, (url) => {
      // console.log(url);
      cb(url.url)
    })
  }



  // Use XMLHttpRequest to upload the file to S3.
  function uploadFile(file, url) {
    console.log(file);
    console.log(url);

    const content = {
      nombre: $('input[name=nombre]').val(),
      nombreFoto: file.name,
      informacion: $('input[name=informacion]').val()
    };

    return Promise.all([
      fetch(url, {
          method: 'PUT',
          headers: new Headers({
            'Content-Type': 'binary/octet-stream'
          }),
          body: file
        }),
      fetch('/admin/servicios/categorias', {
            method: 'POST',
            headers: new Headers({
              'Content-Type': 'application/json'
            }),
            cache: 'no-cache',
            body: JSON.stringify(content)
      })
    ]).then((response) => {
      console.info(response);
      const file = response[0];
      const basaDeDatos = reponse[1];
      // logica
      window.location.reload();
    }).catch((err)=>{
      //manejo de error
      console.error(err);
    });
  }

  </script>
